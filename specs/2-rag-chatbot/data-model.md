# Data Model: Integrated RAG Chatbot

This document outlines the key data entities for the Integrated RAG Chatbot feature.

## Entities

### 1. BookContentChunk

**Description**: A segment of the book's text, used as the basis for retrieval. This entity will be stored in the Qdrant vector store and will be augmented with vector embeddings for semantic search.

**Fields**:
-   `id`: Unique identifier for the chunk (UUID or hash of content + source).
-   `content`: The raw text content of the chunk (string).
-   `source_location`: A structured field indicating where the chunk originated in the book (e.g., chapter, section, page range). (object/string)
-   `embedding`: Vector representation of the content, generated by an embedding model. (array of floats)
-   `metadata`: Additional metadata, e.g., chunk number, title, etc. (object)

**Relationships**:
-   None directly with other entities in this model, but implicitly linked to the book content.

**Validation Rules**:
-   `content` must not be empty.
-   `embedding` must be a valid vector of expected dimension.
-   `source_location` should be parseable and point to a valid location within the book.

### 2. ChatSession

**Description**: Represents a single, continuous conversation between a user and the chatbot. This entity will be stored in Neon Serverless Postgres. An anonymous user identity will be managed via local storage on the client side, and this identity will be associated with the ChatSession on the backend.

**Fields**:
-   `session_id`: Unique identifier for the chat session (UUID).
-   `user_id`: Anonymous user identifier (string, likely a client-generated UUID stored in local storage).
-   `start_time`: Timestamp when the session began (datetime).
-   `last_active_time`: Timestamp of the last message in the session (datetime).
-   `mode`: Current mode of the chatbot (e.g., "full_book", "selection"). (string enum)

**Relationships**:
-   Has many `ChatMessage` (one-to-many relationship).

**Validation Rules**:
-   `session_id` must be unique.
-   `user_id` must be provided.
-   `start_time` must be before `last_active_time`.
-   `mode` must be one of the defined modes.

### 3. ChatMessage

**Description**: A single message within a `ChatSession`, including the sender (user or assistant), the message text, and a timestamp. This entity will be stored in Neon Serverless Postgres.

**Fields**:
-   `message_id`: Unique identifier for the message (UUID).
-   `session_id`: Foreign key referencing the `ChatSession` it belongs to (UUID).
-   `sender`: Role of the sender (e.g., "user", "assistant"). (string enum)
-   `text`: The content of the message (string).
-   `timestamp`: Timestamp when the message was sent/received (datetime).
-   `context_used`: Optional. The specific text selection or document IDs used to generate the assistant's response, if applicable. (string or array of IDs)

**Relationships**:
-   Belongs to one `ChatSession` (many-to-one relationship).

**Validation Rules**:
-   `message_id` must be unique within a session.
-   `session_id` must reference an existing `ChatSession`.
-   `sender` must be either "user" or "assistant".
-   `text` must not be empty.
-   `timestamp` must be a valid datetime.